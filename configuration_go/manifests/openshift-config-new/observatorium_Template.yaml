# Generated by mimic. DO NOT EDIT.
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  creationTimestamp: null
  name: observatorium
objects:
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    creationTimestamp: null
    labels:
      app.kubernetes.io/component: api
      app.kubernetes.io/instance: observatorium
      app.kubernetes.io/name: observatorium-api
      app.kubernetes.io/part-of: observatorium
      app.kubernetes.io/version: ${OBSERVATORIUM_API_IMAGE_TAG}
    name: observatorium-api
    namespace: ${NAMESPACE}
  spec:
    replicas: 3
    selector:
      matchLabels:
        app.kubernetes.io/component: api
        app.kubernetes.io/instance: observatorium
        app.kubernetes.io/name: observatorium-api
        app.kubernetes.io/part-of: observatorium
    strategy: {}
    template:
      metadata:
        creationTimestamp: null
        labels:
          app.kubernetes.io/component: api
          app.kubernetes.io/instance: observatorium
          app.kubernetes.io/name: observatorium-api
          app.kubernetes.io/part-of: observatorium
          app.kubernetes.io/version: ${OBSERVATORIUM_API_IMAGE_TAG}
        namespace: ${NAMESPACE}
      spec:
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchExpressions:
                  - key: app.kubernetes.io/instance
                    operator: In
                    values:
                    - observatorium
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                    - observatorium-api
                topologyKey: kubernetes.io/hostname
              weight: 100
        containers:
        - args:
          - --logs.read.endpoint=http://observatorium-xyz-loki-query-frontend-http.${NAMESPACE}.svc.cluster.local:3100
          - --logs.rules.endpoint=http://observatorium-xyz-loki-ruler-http.${NAMESPACE}.svc.cluster.local:3100
          - --logs.tail.endpoint=http://observatorium-xyz-loki-querier-http.${NAMESPACE}.svc.cluster.local:3100
          - --logs.write.endpoint=http://observatorium-xyz-loki-distributor-http.${NAMESPACE}.svc.cluster.local:3100
          - --metrics.read.endpoint=http://observatorium-xyz-thanos-query-frontend.${NAMESPACE}.svc.cluster.local:9090
          - --metrics.rules.endpoint=http://observatorium-xyz-rules-objstore.${NAMESPACE}.svc.cluster.local:8080
          - --metrics.write.endpoint=http://observatorium-xyz-thanos-receive.${NAMESPACE}.svc.cluster.local:19291
          - --middleware.rate-limiter.grpc-address=observatorium-xyz-gubernator.${NAMESPACE}.svc.cluster.local:8081
          - --rbac.config=/etc/observatorium/rbac/config.yaml
          - --tenants.config=/etc/observatorium/tenants/config.yaml
          - --traces.read.endpoint=http://observatorium-xyz-jaeger-query.${NAMESPACE}.svc.cluster.local:16686/
          - --traces.write.endpoint=observatorium-xyz-otel-collector:4317
          - --log-level=${OBSERVATORIUM_API_LOG_LEVEL}
          image: ${OBSERVATORIUM_API_IMAGE}:${OBSERVATORIUM_API_IMAGE_TAG}
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 8
            httpGet:
              path: /live
              port: 8081
            periodSeconds: 30
            timeoutSeconds: 1
          name: observatorium-api
          ports:
          - containerPort: 8080
            name: http-public
            protocol: TCP
          - containerPort: 8081
            name: http-internal
            protocol: TCP
          - containerPort: 8090
            name: grpc
            protocol: TCP
          readinessProbe:
            failureThreshold: 20
            httpGet:
              path: /ready
              port: 8081
            periodSeconds: 5
          resources:
            limits:
              cpu: "3"
              memory: 3Gi
            requests:
              cpu: "2"
              memory: 2Gi
          terminationMessagePolicy: FallbackToLogsOnError
          volumeMounts:
          - mountPath: /etc/observatorium/rbac
            name: rbac-config
            readOnly: true
          - mountPath: /etc/observatorium/tenants
            name: tenants
            readOnly: true
        nodeSelector:
          kubernetes.io/os: linux
        serviceAccountName: observatorium-api
        terminationGracePeriodSeconds: 120
        volumes:
        - configMap:
            name: observatorium-rbac
          name: rbac-config
        - name: tenants
          secret:
            secretName: observatorium-tenants
  status: {}
- apiVersion: v1
  kind: Service
  metadata:
    creationTimestamp: null
    labels:
      app.kubernetes.io/component: api
      app.kubernetes.io/instance: observatorium
      app.kubernetes.io/name: observatorium-api
      app.kubernetes.io/part-of: observatorium
    name: observatorium-api
    namespace: ${NAMESPACE}
  spec:
    ports:
    - name: http-public
      port: 8080
      protocol: TCP
      targetPort: 8080
    - name: http-internal
      port: 8081
      protocol: TCP
      targetPort: 8081
    - name: grpc
      port: 8090
      protocol: TCP
      targetPort: 8090
    selector:
      app.kubernetes.io/component: api
      app.kubernetes.io/instance: observatorium
      app.kubernetes.io/name: observatorium-api
      app.kubernetes.io/part-of: observatorium
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: ServiceAccount
  metadata:
    creationTimestamp: null
    labels:
      app.kubernetes.io/component: api
      app.kubernetes.io/instance: observatorium
      app.kubernetes.io/name: observatorium-api
      app.kubernetes.io/part-of: observatorium
    name: observatorium-api
    namespace: ${NAMESPACE}
- apiVersion: monitoring.coreos.com/v1
  kind: ServiceMonitor
  metadata:
    creationTimestamp: null
    labels:
      app.kubernetes.io/component: api
      app.kubernetes.io/instance: observatorium
      app.kubernetes.io/name: observatorium-api
      app.kubernetes.io/part-of: observatorium
    name: observatorium-api
    namespace: ${NAMESPACE}
  spec:
    endpoints:
    - port: http-internal
      relabelings:
      - action: replace
        separator: /
        sourceLabels:
        - namespace
        - pod
        targetLabel: instance
    namespaceSelector: {}
    selector:
      matchLabels:
        app.kubernetes.io/component: api
        app.kubernetes.io/instance: observatorium
        app.kubernetes.io/name: observatorium-api
        app.kubernetes.io/part-of: observatorium
- apiVersion: v1
  data:
    config.yaml: |
      roles:
      - name: read-write
        resources:
        - metrics
        - logs
        - traces
        tenants:
        - test-oidc
        permissions:
        - read
        - write
      rolebindings:
      - name: test
        subjects:
        - name: user
          kind: user
        roles:
        - read-write
  kind: ConfigMap
  metadata:
    creationTimestamp: null
    labels:
      app.kubernetes.io/component: api
      app.kubernetes.io/instance: observatorium
      app.kubernetes.io/name: observatorium-api
      app.kubernetes.io/part-of: observatorium
    name: observatorium-rbac
    namespace: ${NAMESPACE}
- apiVersion: v1
  kind: Secret
  metadata:
    creationTimestamp: null
    labels:
      app.kubernetes.io/component: api
      app.kubernetes.io/instance: observatorium
      app.kubernetes.io/name: observatorium-api
      app.kubernetes.io/part-of: observatorium
    name: observatorium-tenants
    namespace: ${NAMESPACE}
  stringData:
    config.yaml: |
      tenants:
      - name: test-oidc
        id: 1610b0c3-c509-4592-a256-a1871353dbfa
        oidc:
          clientID: observatorium
          clientSecret: ""
          issuerURL: http://hydra.hydra.svc.cluster.local:4444/
        rateLimits:
        - endpoint: /api/metrics/v1/.+/api/v1/receive
          limit: 1000
          window: 1s
        - endpoint: /api/logs/v1/.*
          limit: 1000
          window: 1s
parameters:
- name: OBSERVATORIUM_API_IMAGE
  value: quay.io/observatorium/api
- name: OBSERVATORIUM_API_IMAGE_TAG
  value: main-2023-01-24-v0.1.2-318-g5f4fdf4
- name: NAMESPACE
  value: observatorium
- name: OBSERVATORIUM_API_LOG_LEVEL
  value: debug
